name: Auto Patch Next.js Release

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Next.js release tag to patch (e.g. v13.5.6)'
        required: false
        default: ''

jobs:
  patch-nextjs:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout patch repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Determine tag to patch
        id: get_tag
        run: |
          if [[ -n "${{ github.event.inputs.tag }}" ]]; then
            echo "Using manually provided tag: ${{ github.event.inputs.tag }}"
            echo "latest_tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            latest=$(curl -s https://api.github.com/repos/vercel/next.js/releases/latest | jq -r .tag_name)
            echo "latest_tag=$latest" >> $GITHUB_OUTPUT
          fi

      - name: Load last processed tag
        id: load_tag
        run: |
          tag=$(cat .last-tag 2>/dev/null || echo "none")
          echo "last_tag=$tag" >> $GITHUB_OUTPUT

      - name: Compare tags
        id: compare_tags
        run: |
          if [[ "${{ steps.get_tag.outputs.latest_tag }}" == "${{ steps.load_tag.outputs.last_tag }}" ]]; then
            echo "No new release. Skipping."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected: ${{ steps.get_tag.outputs.latest_tag }}"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Run patch script
        if: steps.compare_tags.outputs.should_run == 'true'
        run: |
          chmod +x ./scripts/generate-and-apply-patch.sh
          ./scripts/generate-and-apply-patch.sh --tag=${{ steps.get_tag.outputs.latest_tag }}

      - name: Save processed tag
        if: steps.compare_tags.outputs.should_run == 'true'
        run: echo "${{ steps.get_tag.outputs.latest_tag }}" > .last-tag

      - name: Commit updated tag
        if: steps.compare_tags.outputs.should_run == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .last-tag
          git commit -m "Processed Next.js release ${{ steps.get_tag.outputs.latest_tag }}"
          git push

